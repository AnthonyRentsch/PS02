---
title: "STAT/MATH 495: Problem Set 02"
author: "Anthony Rentsch"
date: "2017-09-19"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 2
    collapsed: false
    smooth_scroll: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.width=8, fig.height=4.5)

# Load packages
#library(dplyr)
#library(ggplot2)
library(tidyverse)
library(broom)
library(corrplot)

# Note the relative file path, and not absolute file path:
# http://www.coffeecup.com/help/articles/absolute-vs-relative-pathslinks/
train <- read.csv("data/train.csv")
test <- read.csv("data/test.csv")
macro <- read.csv("data/macro.csv")
```


# Exploratory Data Analysis

Histogram of the sale price of each property.
```{r}
ggplot(data = train) + geom_histogram(aes(x = price_doc)) + 
  labs(title = "Histogram of outcome variable") +
  theme(plot.title = element_text(hjust = 0.5))
```

Visualize correlation between all property-specific variables, using only complete pairs of observations of any two variables.
```{r}
new <- train[,c(3,4,5,6,8,9,10,292)]
M <- cor(new,use="pairwise.complete.obs")
corrplot(M, method = "circle")
```

The num_rooms variable looks like it has strongest correlation with price_doc, so I will use that as my predictor with the hope that fitting a cubic spline to this data will be less error-prone.

```{r}
ggplot(data = train) + geom_point(aes(x = num_room, y = price_doc)) + 
  labs(title = "Scatterplot of number of rooms vs. price") +
  theme(plot.title = element_text(hjust = 0.5))
```

# Model Fit

Remove properties for which the number of rooms is not included.
```{r}
new.train <- train[-which(is.na(train$num_room)),]
```

Fit spline models for four different degress of freedom.
```{r}
two <- smooth.spline(new.train$num_room, new.train$price_doc, df=2) %>%
  broom::augment() %>% 
  ggplot(aes(x = new.train$num_room)) +
  geom_point(aes(y = new.train$price_doc)) +
  geom_line(aes(y=.fitted), col="blue", size=1) +
  labs(title = "2 degrees of freedom", x = "num_room", y = "price_doc") +
  theme(plot.title = element_text(hjust = 0.5))

seven <- smooth.spline(new.train$num_room, new.train$price_doc, df=7) %>%
  broom::augment() %>% 
  ggplot(aes(x = new.train$num_room)) +
  geom_point(aes(y = new.train$price_doc)) +
  geom_line(aes(y=.fitted), col="blue", size=1) +
  labs(title = "7 degrees of freedom", x = "num_room", y = "price_doc") +
  theme(plot.title = element_text(hjust = 0.5))

 ten <- smooth.spline(new.train$num_room, new.train$price_doc, df=10) %>%
  broom::augment() %>% 
  ggplot(aes(x = new.train$num_room)) +
  geom_point(aes(y = new.train$price_doc)) +
  geom_line(aes(y=.fitted), col="blue", size=1) +
  labs(title = "10 degrees of freedom", x = "num_room", y = "price_doc") +
   theme(plot.title = element_text(hjust = 0.5))

thirteen <- smooth.spline(new.train$num_room, new.train$price_doc, df=13) %>%
  broom::augment() %>% 
  ggplot(aes(x = new.train$num_room)) +
  geom_point(aes(y = new.train$price_doc)) +
  geom_line(aes(y=.fitted), col="blue", size=1) +
  labs(title = "13 degrees of freedom", x = "num_room", y = "price_doc") +
  theme(plot.title = element_text(hjust = 0.5))

two
seven
ten
thirteen
```

# Review and Create Submission File

Will use df = 7 to create spline model, as it appears to give best fit.
```{r}
spline.model <- smooth.spline(new.train$num_room, new.train$price_doc, df = 7)
```

Predict the price_doc for the test set using spline.model.
```{r}
new_data = test$num_room
pred <- predict(spline.model, new_data)
pred <- as.data.frame(pred)
```

Plot original data, spline model, and predictions.
```{r}
spline.model %>% broom::augment() %>% ggplot() +
  geom_point(aes(x = new.train$num_room, y = new.train$price_doc)) +
  geom_line(aes(x = new.train$num_room, y=.fitted), col="blue", size=1) +
  geom_point(data = pred, aes(x = pred$x, y = pred$y), col = "red", size = 3) +
  labs(x = "num_room", y = "price_doc")
```

Create a clean list with id and predicted price_doc and write this list to a .csv file.
```{r}
pred <- cbind(id = test$id, pred)
pred <- pred[,-2]
colnames(pred) <- c("id","price_doc")

write.csv(pred, file = "submission.csv", row.names = F)
```

